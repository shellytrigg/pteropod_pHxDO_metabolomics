---
title: "RelativeStandardDeviation"
author: "Shelly Trigg"
date: "6/9/2020"
output: html_document
---


load libraries
```{r}
library(readxl)
library(ggplot2)
library(gplots)
library(dplyr)

```

read in data
```{r}
metab_data <- read_xlsx("../abundance_visualization/data/mx 338976 Krista Nichols_pteropods_whole animals_09-2017_submit.xlsx", skip = 8) 

lipid_data <- data.frame(read_xlsx("../abundance_visualization/data/mx 339045_Nichols_CSH-QTOF MSMS_lipidomics_09-2017_submit.xlsx", sheet = "submit", skip = 6))

#read in meta data
metab_meta <- read_xlsx("../abundance_visualization/data/mx 338976 Krista Nichols_pteropods_whole animals_09-2017_submit.xlsx", range = "H1:BO8",n_max = 8) 

lipid_meta <- read_xlsx("../abundance_visualization/data/mx 339045_Nichols_CSH-QTOF MSMS_lipidomics_09-2017_submit.xlsx", range = "H1:BW8", n_max = 6, sheet = "submit")

#rename columns 9-67
colnames(metab_data)[9:67] <- as.vector(as.character(data.frame(metab_meta)[3,2:ncol(metab_meta)]))


colnames(lipid_data)[9:75] <- colnames(data.frame(lipid_meta[,-1]))

#remove standards
lipid_data <- lipid_data[-grep("iSTD", lipid_data$Annotation),-grep("Biorec",colnames(lipid_data))]

```

Reshape data to long format
```{r}
STACKED_lipid <- tidyr::gather(lipid_data, "Sample", "peak_height", 9:68)

#transform meta data
STACKED_lipid_meta <- t(lipid_meta)
colnames(STACKED_lipid_meta) <- STACKED_lipid_meta[1,]

STACKED_lipid_meta <- STACKED_lipid_meta[2:nrow(STACKED_lipid_meta),]
colnames(STACKED_lipid_meta)[1] <- "sample_type"
STACKED_lipid_meta <- data.frame(STACKED_lipid_meta)
STACKED_lipid_meta$Sample <- rownames(STACKED_lipid_meta)
rownames(STACKED_lipid_meta) <- NULL

#merge meta data with lipid data
STACKED_lipid <- merge(STACKED_lipid_meta, STACKED_lipid, by = "Sample")



#horizontal data
#horiz_lipid <- data.frame(t(lipid_data[,9:68]))
#colnames(horiz_lipid) <- data.frame(t(lipid_data[,2]))

#horiz_lipid[is.na(horiz_lipid)] <- 0



#lipid_data_log <- log(horiz_lipid,2)

#pca <-  prcomp(lipid_data_log, center = T, scale = T)
```


Calculate relative standard deviation
```{r}

#lipid_RSD_pHDO = STACKED_lipid %>% group_by(Identifier, Treatment) %>% summarise_each(funs(mean, sd))
  #do(lipid_RSD = sd(peak_height, data = .)/mean(peak_height, data =.) *100)

#sd(peak_height)/mean(peak_height) *100

#calculate treatment group mean for each compound
ag_m <- aggregate(peak_height ~ Identifier + Treatment, STACKED_lipid, function(x) mean = mean(x, na.rm = T))
colnames(ag_m)[3] <- "peak_height_m"

#calculate treatment group standard deviation for each compound
ag_sd <- aggregate(peak_height ~ Identifier + Treatment, STACKED_lipid, function(x) sd = sd(x, na.rm = T))
colnames(ag_sd)[3] <- "peak_height_SD"

#calculate the relative standard deviation for each compound
ag_RSD <- merge(ag_m, ag_sd, by = c("Identifier", "Treatment"))
ag_RSD$RSD <- ag_RSD$peak_height_SD/ag_RSD$peak_height_m *100
```


plot distribution of RSDs
```{r}
ggplot(ag_RSD, aes(RSD, color = Treatment), alpha  = 0.5) + geom_density(aes(fill = Treatment), alpha = 0.2) + theme_bw()

# there are 3 compounds with NAs because they did not have enough data
# ag_RSD[which(is.na(ag_RSD$RSD)),]
#      Identifier Treatment peak_height_m peak_height_SD
#300  0.59_329.09        LL          2434             NA
#353  0.61_355.09        LH          5030             NA
#4830 6.40_663.49        HH         43139             NA
#4831 6.40_663.49        HL          7175             NA
#     RSD
#300   NA
#353   NA
#4830  NA
#4831  NA

#For simplicity sake, I'm going to remove these
ag_RSD <- ag_RSD[-grep("0.59_329.09|0.61_355.09|6.40_663.49",ag_RSD$Identifier),]



#plot distribution as boxplots
ggplot(ag_RSD, aes(Treatment,RSD, fill = Treatment)) + geom_boxplot()
```

perform KW test for all lipids collectively
```{r}
kruskal.test(ag_RSD$RSD, ag_RSD$Treatment)

#run a dunn's test
dunn.test::dunn.test(ag_RSD$RSD, ag_RSD$Treatment,method = "bh",kw = T)
```


test if pH or DO has an effect on log RSD
```{r, eval = F}
ag_RSD$pH <- factor(substr(ag_RSD$Treatment,1,1))
ag_RSD$DO <- factor(substr(ag_RSD$Treatment,2,2))


#run kw for each compound
lipid_RSD_pHDO = ag_RSD %>% group_by(Identifier) %>% do(lipid_models = kruskal.test(RSD~Treatment, data = .))
#do(lipid_RSD = sd(peak_height, data = .)/mean(peak_height, data =.) *100)

lipid_RSD_pHDO_summary <- broom::tidy(lipid_RSD_pHDO, lipid_models)
#this gives the same p value for all compounds
```


Threshold for compounds with RSD >= 150 and see if there are group diffs
```{r}
ID150 <- unique(ag_RSD[which(ag_RSD$RSD>=150),"Identifier"])

#run a dunn's test
dunn.test::dunn.test(ag_RSD[which(ag_RSD$Identifier %in% ID150),"RSD"], ag_RSD[which(ag_RSD$Identifier %in% ID150),"Treatment"],method = "bh",kw = T)

ggplot(ag_RSD[which(ag_RSD$Identifier %in% ID150),], aes(Treatment,RSD, fill = Treatment)) + geom_boxplot() + theme_bw()+ ggtitle("RSD thresholded to 150")
```


Threshold for compounds with RSD >= 200 and see if there are group diffs
```{r}
ID200 <- unique(ag_RSD[which(ag_RSD$RSD>=200),"Identifier"])

#run a dunn's test
dunn.test::dunn.test(ag_RSD[which(ag_RSD$Identifier %in% ID200),"RSD"], ag_RSD[which(ag_RSD$Identifier %in% ID200),"Treatment"],method = "bh",kw = T)

ggplot(ag_RSD[which(ag_RSD$Identifier %in% ID200),], aes(Treatment,RSD, fill = Treatment)) + geom_boxplot() + theme_bw() + ggtitle("RSD thresholded to 200")

```

heatmap of RSD thresholded at 150
```{r}
ag_RSD_melt <- ag_RSD[which(ag_RSD$Identifier %in% ID150),c("Identifier", "Treatment", "RSD")]
ag_RSD_melt <- tidyr::spread(ag_RSD_melt, "Treatment", "RSD")
rownames(ag_RSD_melt) <- ag_RSD_melt$Identifier
ag_RSD_melt$Identifier <- NULL

heatmap.2(as.matrix(ag_RSD_melt),margins = c(10,20), distfun = function(x) as.dist(1 - cor(t(x), use = "pa")), hclustfun = function(x) hclust(x,method = 'average'), col= rev(colorRampPalette(RColorBrewer::brewer.pal(10, "RdYlBu"))(256)), na.color = "black", density.info = "none", trace = "none", scale = "row", Colv = NA)

```

heatmap of RSD thresholded at 200
```{r}
ag_RSD_melt <- ag_RSD[which(ag_RSD$Identifier %in% ID200),c("Identifier", "Treatment", "RSD")]
ag_RSD_melt <- tidyr::spread(ag_RSD_melt, "Treatment", "RSD")
rownames(ag_RSD_melt) <- ag_RSD_melt$Identifier
ag_RSD_melt$Identifier <- NULL

heatmap.2(as.matrix(ag_RSD_melt),margins = c(10,20), distfun = function(x) as.dist(1 - cor(t(x), use = "pa")), hclustfun = function(x) hclust(x,method = 'average'), col= rev(colorRampPalette(RColorBrewer::brewer.pal(10, "RdYlBu"))(256)), na.color = "black", density.info = "none", trace = "none", scale = "row", Colv = NA)

```

read in stats data

```{r}
stats_d <- read.csv("../abundance_visualization/data/pteropods_LIPID_univar_PLSDA_supplement.csv", stringsAsFactors = F)

```

apply stats thresholding
```{r}

# overall model pvalue < 0.1 and effect pvalue < 0.05

#Plsda cut off of 1.5


stats_d_cut <- stats_d[which((stats_d$Pr..Chisq._overall < 0.1 & stats_d$DO_p.value < 0.05 ) | (stats_d$Pr..Chisq._overall < 0.1 & stats_d$pH_p.value < 0.05 ) | (stats_d$Pr..Chisq._overall < 0.1 & stats_d$pH.DO_p.value < 0.05 ) | stats_d$VIP_PLSDA_comp1 >= 1.5),]

```

add colors to describe significance

```{r}
stats_d_cut$PLSDA <- ifelse(stats_d_cut$VIP_PLSDA_comp1 >= 1.5, "PLSDA", "NO") 

stats_d_cut$uniDO <- ifelse(stats_d_cut$DO_p.value < 0.05, "uniDO", "NO") 

stats_d_cut$unipH <- ifelse(stats_d_cut$pH_p.value < 0.05, "unipH", "NO") 

stats_d_cut$unipHxDO <- ifelse(stats_d_cut$pH.DO_p.value < 0.05, "unipHxDO", "NO") 

stats_d_cut$method <- paste(stats_d_cut$uniDO, stats_d_cut$unipH, stats_d_cut$unipHxDO, stats_d_cut$PLSDA, sep ="_")

stats_d_cut$method <- gsub("_NO", "", stats_d_cut$method)

stats_d_cut$method <- gsub("NO_", "", stats_d_cut$method)

#see how many fall into the different stats categories
table(stats_d_cut$method)

#create a simplified methods column
for(i in 1:nrow(stats_d_cut)){
  if(grepl("PLSDA",stats_d_cut$method[i]) & grepl("uni", stats_d_cut$method[i])){
    stats_d_cut$method_simple[i] <- "both"
  }
  if(!(grepl("PLSDA",stats_d_cut$method[i])) & grepl("uni", stats_d_cut$method[i])){
    stats_d_cut$method_simple[i] <- "uni"
  }
  if(grepl("PLSDA",stats_d_cut$method[i]) & (!(grepl("uni", stats_d_cut$method[i])))){
    stats_d_cut$method_simple[i] <- "PLSDA"
  }
}

```

convert names to identifiers only
```{r}
#read in data with R names 

lipid_r_data <- read.csv("../MetamappAnalysis/data/mx339045_lipid_sampleTRTlipidsonly.csv", stringsAsFactors = F)

#create key

lipid_name_key <- cbind(lipid_data[order(lipid_data$Annotation),c("Identifier", "Annotation")],r_names = colnames(lipid_r_data[,-c(1:2)]))


colnames(stats_d_cut)[1] <- "r_names"

stats_d_cut <- merge(lipid_name_key, stats_d_cut, by = "r_names")
```


subset RSD data for significant compoounds
```{r}
ag_RSD_sig <- merge(stats_d_cut, ag_RSD, by = "Identifier", all.y = T)

#convert NAs to not_sig
ag_RSD_sig$method_simple[is.na(ag_RSD_sig$method_simple)] <- "not_sig"

#create a column denoting sig or not sig
ag_RSD_sig$sig <- ifelse(ag_RSD_sig$method_simple == "not_sig","not_sig", "sig")

#create column for plotting sig and non.sig sidexside

ag_RSD_sig$meth_sig <- paste(ag_RSD_sig$Treatment,ag_RSD_sig$sig, sep = "_" )

```

plot significant compounds with colors
```{r}
#plot distribution as boxplots
ggplot(ag_RSD_sig[which(ag_RSD_sig$method_simple!="not_sig"),], aes(Treatment,RSD, fill = Treatment)) + geom_boxplot(outlier.shape = NA, alpha = 0.5) + geom_jitter(aes(color = method_simple),width = 0.2, alpha = 0.4) + theme_bw() + scale_color_manual(values = c("black", "orange", "blue")) + ggtitle("RSD x treatment for significant lipids")
```

plot with all compounds 
```{r}
#plot distribution as boxplots
ggplot(ag_RSD_sig, aes(Treatment,RSD, fill = Treatment)) + geom_boxplot(outlier.shape = NA, alpha = 0.5) + geom_jitter(aes(color = method_simple, size = method_simple),width = 0.2, alpha = 0.4) + theme_bw() + scale_color_manual(values = c("black", "gray", "orange", "blue")) + scale_size_manual(values = c(1,0.5,1,1)) 
```

plot with all compounds side x side
```{r}
#plot distribution as boxplots
ggplot(ag_RSD_sig, aes(meth_sig,RSD, fill = Treatment)) + geom_boxplot(outlier.shape = NA, alpha = 0.5) + geom_jitter(aes(color = method_simple),size = 0.8,width = 0.2, alpha = 0.5) + theme_bw() + scale_color_manual(values = c("black", "gray", "orange", "blue")) + xlab("Treatment")
```



look for correlation between pvalue or VIP and RSD
```{r}

ggplot(ag_RSD_sig[which(ag_RSD_sig$DO_p.value < 0.05),], aes(DO_p.value, RSD, color = Treatment)) + geom_point() + ggtitle("Correlation check: RSD x DO pval for p < 0.05") + theme_bw()

ggplot(ag_RSD_sig[which(ag_RSD_sig$pH_p.value < 0.05),], aes(pH_p.value, RSD, color = Treatment)) + geom_point()+ ggtitle("Correlation check: RSD x pH correlation pval for p < 0.05") + theme_bw()

ggplot(ag_RSD_sig[which(ag_RSD_sig$pH_p.value < 0.05),], aes(pH.DO_p.value, RSD, color = Treatment)) + geom_point()+ ggtitle("Correlation check: RSD x pH*DO pval for p < 0.05") + theme_bw()

ggplot(ag_RSD_sig[which(ag_RSD_sig$VIP_PLSDA_comp1 >= 1.5),], aes(VIP_PLSDA_comp1, RSD, color = Treatment)) + geom_point()+ ggtitle("Correlation check: RSD x PLSDA VIP for VIP >= 1.5")+ theme_bw()

```
